version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Install dependencies
        - npm ci
    build:
      commands:
        # Set environment variables for Next.js
        - env | grep -e CLOUD_ACCESS_KEY_ID -e CLOUD_SECRET_ACCESS_KEY -e CLOUD_REGION -e S3_BUCKET_NAME >> .env.production
        - env | grep -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_REGION -e AWS_S3_BUCKET_NAME >> .env.production
        - env | grep -e NEXT_PUBLIC_ >> .env.production
        # Build the Next.js application
        - npm run build
        # Generate initial configuration if needed
        - echo "Build completed successfully"
  artifacts:
    # Output directory for Next.js standalone build
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# Backend configuration for API routes
backend:
  phases:
    build:
      commands:
        - echo "Backend build phase - API routes are handled by Next.js"

# Custom headers for file serving
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  - pattern: '/api/**'
    headers:
      - key: 'Cache-Control'
        value: 'no-cache, no-store, must-revalidate'
  - pattern: '**/*.json'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=300'
  - pattern: '**/*.csv'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=300'
      - key: 'Content-Type'
        value: 'text/csv'
  - pattern: '**/*.jpg'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'
      - key: 'Content-Type'
        value: 'image/jpeg'
  - pattern: '**/*.png'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'
      - key: 'Content-Type'
        value: 'image/png'

# Redirects and rewrites
redirects:
  - source: '/api/files/<*>'
    target: '/api/files/<*>'
    status: '200'
    condition: null

# Environment-specific configuration
test:
  phases:
    preTest:
      commands:
        - npm run test:config
    test:
      commands:
        - npm run test:coverage
  artifacts:
    baseDirectory: coverage
    files:
      - '**/*'